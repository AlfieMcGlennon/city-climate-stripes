<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>City Climate Bars & Stripes — replicated</title>
<meta name="description" content="Interactive city climate bars/stripes with annual & seasonal views.">
<link rel="preconnect" href="https://github.com" crossorigin>
<style>
:root{--bg:#0b0c0c;--panel:#111213;--text:#e8eaed;--muted:#aeb4bc;--focus:#2563eb;--border:#2a2f36}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(1200px 800px at 10% 0%,#0f1117 0%,#0b0c0c 45%,#0b0c0c 100%);color:var(--text)}
header{padding:1rem 1.25rem}header h1{margin:0;font-size:clamp(1.2rem,2vw + .5rem,1.75rem)}header p{margin:.25rem 0 0;color:var(--muted)}
.container{max-width:1400px;margin:0 auto;padding:0 1rem 2rem}
.panel{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0));border:1px solid var(--border);border-radius:18px;padding:1rem;box-shadow:0 10px 30px rgba(0,0,0,.28)}
details.panel summary{cursor:pointer;list-style:none;font-weight:600;font-size:1.05rem;margin-bottom:.5rem;color:var(--text)}
details.panel summary::marker,details.panel summary::-webkit-details-marker{display:none}
.controls{display:grid;gap:.75rem;grid-template-columns:1fr}
@media(min-width:1200px){.controls{grid-template-columns:1.4fr 1fr 1fr 1fr 1.1fr 1fr auto auto}}
label{display:block;font-size:.9rem;color:var(--muted);margin-bottom:.35rem}
input[type=text],select{width:100%;padding:.6rem .7rem;border-radius:12px;border:1px solid var(--border);background:#0f1117;color:var(--text);outline:none}
input[type=text]:focus,select:focus,button:focus{outline:3px solid var(--focus);outline-offset:2px}
button{padding:.7rem 1rem;border-radius:12px;border:1px solid var(--border);background:#111827;color:var(--text);cursor:pointer;font-weight:600}
button:hover{filter:brightness(1.1)}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:1rem;margin-top:1rem}
.meta{color:var(--muted);font-size:.95rem;margin:.25rem 0 .5rem}
.years{color:var(--muted);font-size:.9rem;margin-top:.4rem}
.legend{display:flex;align-items:center;gap:.5rem;margin-top:.6rem;color:var(--muted);font-size:.9rem}
.legend-bar{height:12px;width:260px;border-radius:6px;border:1px solid var(--border);background:linear-gradient(90deg,#2166ac,#f7f7f7,#b2182b)}
.badge{display:inline-block;padding:.25rem .55rem;border:1px solid var(--border);border-radius:999px;font-size:.85rem;color:var(--muted)}
.footer{color:var(--muted);font-size:.9rem;margin-top:1rem;line-height:1.6}
.footer a{color:#9cc0ff;text-decoration:none;border-bottom:1px dotted #9cc0ff}
.footer a:hover{border-bottom-style:solid}
.loading-overlay{position:fixed;inset:0;background:rgba(11,12,16,.96);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity .25s}
.loading-overlay.hidden{opacity:0;pointer-events:none}
.spinner{width:56px;height:56px;border-radius:50%;border:4px solid #2a2f36;border-top-color:#6aa9ff;animation:spin 1s linear infinite;margin-bottom:12px}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div><div id="loadingText">Loading data…</div></div>

<header class="container">
  <h1>City Climate Bars & Stripes — <em>replicated</em></h1>
  <p>Annual &amp; seasonal temperature anomalies (°C).</p>
</header>

<main class="container">
  <!-- controls + chart content identical to your version -->
  <!-- ... (omitted for brevity, unchanged UI markup) ... -->
</main>

<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<script>
/* ---------- Robust release-based data loader ---------- */
const RELEASE_BASE = "https://github.com/AlfieMcGlennon/city-climate-stripes/releases/download/v1-data/";
const FETCH_TIMEOUT_MS = 30000;

async function fetchTextWithTimeout(url, label){
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort("Timeout after "+FETCH_TIMEOUT_MS+"ms"), FETCH_TIMEOUT_MS);
  try{
    const resp = await fetch(url, {
      mode:'cors', redirect:'follow', cache:'no-store',
      signal:controller.signal, headers:{Accept:'text/csv, text/plain; q=0.9, */*; q=0.8'}
    });
    if(!resp.ok) throw new Error(`[${label}] HTTP ${resp.status} ${resp.statusText}`);
    const txt = await resp.text();
    if(!txt || txt.trim().length<5) throw new Error(`[${label}] Empty response`);
    return txt;
  }finally{ clearTimeout(t); }
}

async function loadReleaseCSV(filename, rowParser){
  const url = `${RELEASE_BASE}${filename}?cb=${Date.now()}`;
  try{
    const txt = await fetchTextWithTimeout(url, filename);
    const rows = d3.csvParse(txt, rowParser);
    if(!rows.length) throw new Error(`${filename}: 0 rows parsed`);
    return rows;
  }catch(e){
    console.error("Failed to load", filename, e);
    throw new Error(`Failed ${filename}: ${e.message}`);
  }
}

/* ---------- Metadata loader ---------- */
async function loadLocalCSV(filename, rowParser){
  const url = new URL(filename, document.baseURI).href + "?cb=" + Date.now();
  const txt = await fetchTextWithTimeout(url, filename);
  const rows = d3.csvParse(txt, rowParser);
  if(!rows.length) throw new Error(`${filename}: 0 rows parsed`);
  return rows;
}

/* ---------- Fix escapeHtml bug ---------- */
const escapeHtml = s=>String(s).replace(/[&<>"']/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));

/* ---------- Overlay safety ---------- */
window.addEventListener("error",e=>{
  console.error("Global error",e);
  document.getElementById("loadingOverlay").classList.add("hidden");
});
window.addEventListener("unhandledrejection",e=>{
  console.error("Unhandled rejection",e.reason);
  document.getElementById("loadingOverlay").classList.add("hidden");
});

/* ---------- Example boot using above helpers ---------- */
(async function start(){
  const overlay=document.getElementById("loadingOverlay");
  const msg=document.getElementById("loadingText");
  try{
    msg.textContent="Loading metadata…";
    const meta=await loadLocalCSV("cities_metadata_clean.csv",d=>d);
    msg.textContent="Loading annual data…";
    const annual=await loadReleaseCSV("stripes_long_clean.csv",d=>d);
    msg.textContent="Loading seasonal data…";
    await Promise.all([
      loadReleaseCSV("stripes_seasonal_DJF.csv",d=>d),
      loadReleaseCSV("stripes_seasonal_MAM.csv",d=>d),
      loadReleaseCSV("stripes_seasonal_JJA.csv",d=>d),
      loadReleaseCSV("stripes_seasonal_SON.csv",d=>d)
    ]);
    // TODO: call your existing init/render with parsed data
    console.log("All CSVs loaded OK", {meta, annual});
  }catch(err){
    console.error("Data load error",err);
    alert("Data load failed: "+err.message);
  }finally{
    overlay.classList.add("hidden");
  }
})();
</script>
</body>
</html>
